name: Deploy Website

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Hardened dependency install
        run: |
          echo "üèóÔ∏è Starting resilient install pipeline"

          echo "üëâ Step 1: Try normal npm install"
          npm install --fetch-retries=5 --fetch-retry-factor=2 --legacy-peer-deps || INSTALL_FAIL=$?

          if [ "$INSTALL_FAIL" != "" ]; then
            echo "‚ö†Ô∏è npm registry failed. Switching to mirror‚Ä¶"
            npm config set registry https://registry.npmmirror.com

            echo "üëâ Step 2: Retry npm with mirror"
            npm install --fetch-retries=5 --fetch-retry-factor=2 --legacy-peer-deps || MIRROR_FAIL=$?
          fi

          if [ "$MIRROR_FAIL" != "" ]; then
            echo "‚ö†Ô∏è Mirror also failed. Installing pnpm fallback‚Ä¶"
            npm install -g pnpm

            echo "üëâ Step 3: Try installing with pnpm"
            pnpm install || PNPM_FAIL=$?
          fi

          if [ "$PNPM_FAIL" != "" ]; then
            echo "‚ö†Ô∏è pnpm failed. Installing yarn fallback‚Ä¶"
            npm install -g yarn

            echo "üëâ Step 4: Try installing with yarn"
            yarn install || YARN_FAIL=$?
          fi

          if [ "$YARN_FAIL" != "" ]; then
            echo "‚ùå All installers failed. Failing pipeline."
            exit 1
          fi

          echo "‚úÖ Dependencies installed successfully!"

      - name: Build site
        run: npm run build || pnpm build || yarn build

      - name: Copy dist to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: xevrion
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/*"
          target: "/home/xevrion/thy/dist/"

      - name: Reload nginx
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: xevrion
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl reload nginx
